<!DOCTYPE html>
<html class="ocks-org do-not-copy">
<meta charset="utf-8">
<title>Flu Vaccination Rate</title>
<head><link rel="stylesheet" type="text/css" href="flu_style.css" /></head>

<style>

.axis path{
  stroke: none;
  fill: none;
  stroke: #FFF;
  shape-rendering: crispEdges;
}


.axis line {
  stroke: none;
  fill: none;
  stroke: #FFF;
  shape-rendering: crispEdges;
}


</style>
<body>
<div class="title">Georgia lags in flu vaccination rates</div>
<div class="subtitle">Georgia brought down the national flu vaccination rate during the 2012-2103 season.<br><br></div>

<div class="explainer">
Georgians face some of the same barriers to a flu shot as people in the rest of the country, like getting time off work to take the family for their immunization, according to the Georgia Department of Public Health. Pregnant women are a special concern as 41 Georgia counties have no OB service.<br><br>

This school year, the DPH is repeating a school-based program that nearly doubled the number of K-12-age children vaccinated in 2012-2013. County health departments partner with community groups, places of worship and employers to deploy shots at convenient, accesible times and places.<br><br>

The DPH advises everyone over the age of 6 months to get an annual flu shot.
<br><br>
</div>

<div>Click to see how your demographic stacks up:</div>

<p class = "legendHolder"> </p>

<p class="chart"></p>

<p class="footer">

<br>
<br>

  May, 2013 cumulative flu vaccination rate for the 2012-2013 flu season. Vaccination coverage estimates by State National Immunization Survey (NIS) and Behavioral Risk Factor Surveillance System (BRFSS), 2012â€“13 influenza season.
<br>
<br>
Numbers reflect a 95% confidence interval with margin of error under 5 percent.
<br>
<br>
Source: <a href="http://www.cdc.gov/flu/fluvaxview/coverage-1213estimates.htm" target="_blank">http://www.cdc.gov/flu/fluvaxview/coverage-1213estimates.htm</a>
<br><br>
Methodology:
The data above was downlaoded Sept. 9 from the CDC as a spreadsheet, concatenated and refined using Python, then filtered and graphed with Javascript.
<br>
<br>
* CDC reports insufficient data

<script>document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] + ':35729/livereload.js?snipver=1"></' + 'script>')</script>
<script src="http://d3js.org/d3.v2.min.js?2.9.1"></script>
<script>

console.log("ok");


// ************ DECLARATIONS

var margin = {top: 10, right: 100, bottom: 10, left: 10},
    width = window.innerWidth,
    width = width - margin.left - margin.right,
    height = (width * 1.3) - margin.top - margin.bottom;


var states,
    age;

var x = d3.scale.linear()
    .domain([0, 100])// Don't use max function. Hardcode 100 b/c 100 is the real-life maximum vaccination rate.
    .range([0, width]);

var y = d3.scale.ordinal()
    .rangeRoundBands([0, height], .1);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("top")
    .tickSize(-height - margin.bottom);
    //.tickFormat(format);

var color = d3.scale.category10();

var svg = d3.select(".chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .style("margin-left", -margin.left + "px")
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

svg.append("g")
    .attr("class", "x axis");

// ******** END DECLARATIONS

// ********* LOAD DATA, SORT & FILTER

d3.csv("flu_vaccination.csv", function(data) {

  states = data;

  var ages = d3.keys(states[0]).filter(function(key) {
    return key != "State";
  });

color.domain(ages);
default_age = "6 months - 17 years"; // initialize the age to be graphed

  states.forEach(function(state) {
    ages.forEach(function(age) {
      state[age] = state[age];
    });
  });

  // ******* DATA SORTED, LOADED, FILTERED

  //******** LEGEND

  d3.select("window").on("resize", resize);

  var legendHolder = d3.select(".legendHolder").append("svg").attr("height", height*0.13);

  var legend = legendHolder.selectAll(".legend")
    .data(color.domain().slice())
      .enter().append("g")
      .attr("class", "legend")
      .attr("transform", 
          function (d, i) 
          {if (i%2)
            { return "translate(" + width*0.39 + "," + i*(height*0.013)  + ")";} // space horizontal & vertical
            { return "translate(" + width*0.05  +  "," + i*(height*0.013) + ")";} 
          });

  legend.append("rect")
      .attr("width", width*0.03)
      .attr("height", width*0.03)     
      .style("fill", color)
      .on("click", function (d) {
        default_age = d; // reset the age we'll draw with to whatever we click on
        return change();}); //then call the change function


  legend.append("text")
      .attr("dy", "1em")
      .attr("dx", width*0.04)
      .style("text-anchor", "start")
      .text(function (d) {return d; })
      .on("click", function (d) {
        default_age = d;
        return change();});




  redraw();
}); // CLOSE INITIAL FUNCTION

var altKey;

d3.select(window)
    .on("keydown", function() { altKey = d3.event.altKey; })
    .on("keyup", function() { altKey = false; });

// ******** CHANGE FUNCTION

function change() {

  d3.transition()
      .duration(altKey ? 7500 : 750)
      .each(redraw);
}

//********* DRAW FUNCTION

function redraw() {

    var age1 = default_age,
    top = states.sort(function(a, b) { return b[age1] - a[age1]; });

  y.domain(top.map(function(d) { return d.State; }));

  var bar = svg.selectAll(".bar")
      .data(top, function(d) { return d.State; })
      .attr("class", "bar");

  // entering transition

  var barEnter = bar.enter().insert("g", ".axis")
      .attr("class", "bar")
      .attr("transform", function(d) { return "translate(0," + (y(d.State) + height) + ")"; })
      .style("fill-opacity", 0); // this is when it's flipping around

  barEnter.append("rect")
      .attr("width", 50)
      .attr("height", y.rangeBand());

  barEnter.append("text")
      .attr("class", "label")
      .attr("x", -3)
      .attr("y", y.rangeBand() / 2)
      .attr("dy", ".35em")
      .attr("text-anchor", "end")
      // string "District of Columbia" is too long.
      .text( function (d) {
        if (d.State == "District of Columbia") {return "DC";}
        {return d.State;}
      });

  barEnter.append("text") // This sets up to add "*" when there is N/A
    .attr("class", "footnote")
    .attr("x", -3)
    .attr("y", y.rangeBand()/2)
    .attr("dy", ".35em")
    .attr("text-anchor", "start");

      
  // first transition done, now drawing updated bar

  age = age1;

  var barUpdate = d3.transition(bar)
      //transform it a little further right for the labels
      .attr("transform", function(d) { return "translate(80," + (d.y0 = y(d.State)) + ")"; })
      .style("fill-opacity", 1.0); // this is the default

  barUpdate.select("rect")
      .attr("width", function (d) { return x(d[age]);})
      .attr("fill", function (d) {
        if (d.State == "Georgia") {return "goldenrod";} // Highlight Georgia
        else {return color(age); } ;})
      .attr("fill-opacity", function (d) {
        if (d.State == "United States") {return 0.6;} ;});// Highlight U.S. average

      
  barUpdate.select("text.footnote") // this adds "*" where there is N/A
    .attr("x", function (d) {
      return x(d[age]);
    })
    .text(function (d) {
      if(d[age] == "") {return "*";}
      else {return "";}
    });



  // now wiping away bars

  var barExit = d3.transition(bar.exit())
      .attr("transform", function(d) { return "translate(0," + (d.y0 + height) + ")"; })
      .style("fill-opacity", 1) //this is when it's flipping around
      .remove();

  barExit.select("rect")
      .attr("width", 50);

  barExit.select(".value")
      .attr("x", function(d) { return x(d[age]) - 3; })
      .text(function(d) { return format(d[age]); });

  d3.transition(svg).select(".axis")
      //again, translate a little further right for space for labels
      .attr("transform", function(d) { return "translate(80," + 0 + ")"; })
      .call(xAxis);
}
// ****** END DRAW FUNCTION

// ******** RESIZE FUNCTION

function resize() {
  width = window.innerWidth;
  width = width - margin.left - margin.right;

  x.range([0, width]);

}



</script>
</body>
</html>
